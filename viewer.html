<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta Http-Equiv="Cache-Control" Content="no-cache">
    <meta Http-Equiv="Pragma" Content="no-cache">
    <meta Http-Equiv="Expires" Content="0">
    <meta Http-Equiv="Pragma-directive: no-cache">
    <meta Http-Equiv="Cache-directive: no-cache">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>    
    <script src="http://malsup.github.com/jquery.form.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="leaflet.label.js"></script>
    
    <script src="fileTree.js"></script>
    <script src="marker.js"></script>
    <script src="view.js"></script>
    <script src="tileLayer.js"></script>
    <script src="icon.js"></script>
    <script src="map.js"></script>
    <script src="pvrPlayer.js"></script>
    <script src="embedpano.js"></script>
    <script src="video.js"></script>
    <script src="videoPlayer.js"></script>
    <script src="polyline.js"></script>

    <link rel="stylesheet" href="fileTree.css" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css" />
    <link rel="stylesheet" href="leaflet.label.css" />

    <style>
      @import url(http://fonts.googleapis.com/earlyaccess/nanumgothic.css);
      html {width:100%;height:100%;}
      body {margin:0; font-family:nanumgothic; display:inline-block; float:left; width:100%; height:100%; -webkit-user-select:none;
        -ms-user-select:none;
      }

      .vcomplex {
        display: flex;
        display: -ms-flexbox;
        display: -webkit-box;
        display: -moz-box;
        -webkit-box-orient: vertical;
        -moz-box-orient: vertical;
        flex-direction: column;
        -ms-flex-direction: column;
      }
      .vrcomplex {
        display: flex;
        display: -ms-flexbox;
        display: -webkit-box;
        display: -moz-box;
        -webkit-box-orient: vertical;
        -moz-box-orient: vertical;
        -webkit-box-direction: reverse;
        -moz=box-direction: reverse;
        flex-direction: column-reverse;
        -ms-flex-direction:column-reverse;}
      .hcomplex {
        display: flex;
        display: -ms-flexbox;
        display: -webkit-box;
        display: -moz-box;
        flex-direction: row; 
        -ms-flex-direction:row;
      }
      .restContainer {
        flex: 1;
        -ms-flex: 1;
        -webkit-box-flex: 1;
        -moz-box-flex: 1;
        position:relative;
      }
      .restContainer .confirmSize{position:absolute;}


      .menuBar1 {width:100%;height:45px;position:relative;}
      .menuBar1 .barShadow {box-shadow: 0px 10px 5px -5px #D5D5D5 inset; position:absolute; top:45px; height:10px; z-index:1000001; width:100%; pointer-events:none;}

      .leftAlign {float:left;}
      .rightAlign {float:right;}
      .area {display:inline-block; padding:10px; line-height:0;}
      .textArea {display:inline-block; padding:10px; line-height:1; font-size:25px;}
      .textArea.smalltext {font-size:20px;padding-top:15px;}
      .bold {font-weight:bold;}
      .button {
        display: inline-block;
        font-weight:bold; 
        padding:5px; background-color:#BDBDBD;
        text-align:center;
        color:white;
        cursor:pointer;
      }
      .button.width4 {width:100px;}
      .button.height1 {
        height:15px; padding-top:5px; padding-bottom:5px;
        font-size:15px; line-height:1;
      }
      .button.round {border-radius:5px;}
      .button.active {
        background-color: #8C8C8C;
        cursor: default;
      }

      .hSizeHandler {width:10px; background-color:#EAEAEA; cursor:col-resize;}
      .vSizeHandler {height:10px; background-color:#EAEAEA; cursor:row-resize;}


      .halfContainer {flex:1; -ms-flex:1; height:100%; float:left;}
      .fullContainer {width:100%; height:100%;}
      
      .leaflet-container {background-color: white}
      .hidden {display:none;}

      .topBar {background-color:#E9EDEE;}
      #myKrpano>div>div:nth-child(1), #myKrpano>div>div:nth-child(2) {z-index:1000000;}
      #leftContainer {
        flex:initial; 
        -ms-flex:inherit; 
        -webkit-box-flex: initial;
        -moz-box-flex: initial; 
        width:50%;}
      
      .labelForInformation {max-width:200px; white-space:pre; word-wrap:break-word; float:left;}
      .labelForInformation .titleContainer {width:100%;float:left;clear:both;}
      .labelForInformation .imgContainer {max-width:200px; min-width:200px; max-height:150px; clear:both;margin-top:5px;}
      .labelForInformation .imgContainer img {max-width:100% !important; max-height:100%;margin:0 auto; display:block;}
      .labelForInformation .textContainer {width:100%; float:left;clear:both;font-weight:normal;margin-top:5px;}

      .hidden{display:none;}

      #linkPopupContainer {width:100%; height:100%; padding:8px; 
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        -ms-box-sizing: border-box;
        -moz-box-sizing: borer-box;
        position:absolute;
        z-index:10000;
      }
      #linkPopupBody {width:100%; height:100%; box-shadow:5px 5px 5px;
        background-color: white;
        box-shadow:0 0 5px #666666;
        display: flex;
        display: -ms-flexbox;
        display: -webkit-box;
        display: -moz-box;
        -webkit-box-orient: vertical;
        -moz-box-orient: vertical;
        flex-direction: column;
        -ms-flex-direction: column;
      }
      #linkPopupMenuBar {width:100%; height:30px;
        -webkit-user-select:none;
        cursor:default;
      }
      #linkPopupMenuBar .closeBox {line-height:0.5; padding:4px; font-size:40px; float:right; cursor:pointer;}
      #linkPopupMenuBar .closeBox:hover {color:red;}
      #linkPopupContentWrapper {flex:1; -ms-flex:1; width:100%; position:relative;}
      #linkPopupContent {position:absolute; width:100%; height:100%;}
      #linkPopupContent iframe {border:0; margin:0; width:100%; height:100%;}
      #linkPopupContent iframe::-webkit-scrollbar{width:5px; height:5px; background-color:rgba(0,0,0,0);}
      #linkPopupContent iframe::-webkit-scrollbar-thumb{width:5px; height:5px; background-color:#B2B7BA;border-radius:2px;}
      
      .transparent {
        visibility:hidden;
      }
      .transparent div{
        visibility:hidden;
      }
      .leaflet-label {z-index:5000;}
      .tightenSize {overflow:hidden;}
    </style>
  </head>
  <body>
    <div class="vcomplex fullContainer">
      <div class="topBar menuBar1">
        <div id="viewNameArea" class="textArea leftAlign bold">전체 보기</div>
        <div id="modeNameArea" class="textArea leftAlign smalltext">가로 보기</div>
        <div class="area rightAlign">
          <div id="changeDataButton" class="button width4 height1 round hidden">전체 보기</div>
          <div id="changeViewButton" class="button width4 height1 round">방향전환</div>
          <div id="logoutButton" class="button width4 height1 round">로그아웃</div>
        </div>      
        <div class="barShadow"></div>
      </div>
      <div id="totalContainer" class="restContainer">
        <div class="confirmSize hcomplex fullContainer">
          <div id="leftContainer" class="restContainer whalf">
            <div id="mapContainer" class="fullContainer confirmSize"></div>
            <div id="linkPopupContainer" class="hidden">
              <div id="linkPopupBody">
                <div id="linkPopupMenuBar">
                  <div class="closeBox">×</div>
                </div>
                <div id="linkPopupContentWrapper">
                  <div id="linkPopupContent">
                    <iframe></iframe>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="sizeHandler" class="hSizeHandler"></div>
          <div class="restContainer">
            <div id="pvrContainer" class="pvrContents fullContainer confirmSize"></div>
            <div id="videoContainer" class="videoContents tightenSize fullContainer confirmSize"></div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
    var file, db, curMainData, curMainIcon, projectId = null, userId,
        googleTileUrl = "https://mts1.google.com/vt/lyrs=m@231000000&hl=ko&gl=KR&src=app&x={x}&y={y}&z={z}&s={s}",
        map = null, pvrPlayer = null, viewMode='h', showProject = false, videoPlayer;

    function loadForView(){
        var layerList, tempIcon, tempLayer, mainLayer;

        $('#myKrpano').remove();
        $('#pathArea').html('');
        $('#anchor').addClass('hidden');
        $('.propertyElement').addClass('hidden');

        curMainData = null;
        curMainIcon = null;

        for(key in db){
          if(key != "user"){
            db[key] = {};  
          }        
        }

        if(map){
          map.map.remove();
          map._curLayer = null;
        } 
        if(pvrPlayer){
          removepano('myKrpano');
        } 
        if(videoPlayer){
          removepano('videoKrpano');
        } 
        $('.iconBox:not(.first)').remove();

        $('#viewNameArea').html('전체 보기');
        $.ajax({
          async: false,
          type: 'post',
          url: 'member.php',
          data: {
            req: 'checkLoginAndType'
          },
          dataType: 'json',
          success: function (data){
            if(data.result == 'logout') location.replace('login.php');
            if(data.type == 'real_estate') location.replace('real_estate.html');
            if(data.type == 'editor') location.replace('index.html');
            userId = data.id;
          }
        });
        map = new Map(0, "mapContainer", {
          mode  : "edit",
          useView : true,
        });
        embedpano({
          target: "pvrContainer", 
          id: "myKrpano", 
          bgcolor: "#FFFFFF", 
          html5: "only", 
          swf: "krpano.swf",
          xml: noCacheUrl("template/krpano.xml"),
          onready: setPvrPlayer
        });
        
        //아이콘 추가, id=1
        tempIcon = {
          id: 1,
          options: {
            iconUrl: 'source/marker_icon2.png',
            size: {
              x: 25, y: 40
            },
            iconAnchor: {
              x: 12.5, y: 20
            },
            actionType: 'none',
            type: 'markerIcon'
          }
        }
        db['markerIcon'][1] = tempIcon;
        map.addIcon(tempIcon.id, tempIcon.options);
        //레이어 추가 , id=1
        tempLayer = {
          id: 1,
          tileUrl: googleTileUrl,
          options: {
            type: 'layer',
            mainView:{
              latlng:{lat: 36.2, lng: 127.26}, 
              zoom: 7
            },
            maxZoom: 18,
            minZoom: 5,
            maxNativeZoom: 22,
            tileImageType: 'presetMap'
          }        
        }
        db['layer'][1] = tempLayer;
        mainLayer = map.addTileLayer(tempLayer.id, tempLayer.tileUrl, tempLayer.options);

        map.changeLayer(mainLayer.id);
        map.map.setView(mainLayer.options.mainView.latlng, mainLayer.options.mainView.zoom);

        $.ajax({
          async: false,
          type: 'get',
          url: 'getData.php',
          data: {
            req: 'getMarkersOfAllUsers',
          },
          dataType: 'json',
          success: function (data){
            var i, newNode, newMarker;

            if(data.error){
              return false;
            }
            else {
              //모든 마커를 추가 
              for(i=0; i<data.markers.length; i++){
                newNode = data.markers[i];
                newNode.id = i;
                newNode.options.draggable = false;
                newNode.options.layerId = 1;
                newNode.options.iconId = 1;

                db[newNode.options.type][newNode.id] = newNode; 
                newMarker = map.addMarker(newNode.id, newNode.latlng, newNode.options);          
                newMarker.on('click', function (){
                  var linkedPvr, linkedVtour, markerName = null;


                  if(curMainIcon && curMainIcon.id != this.id){
                    map.markerList[curMainIcon.id].unbindLabel();
                  } 
                  curMainIcon = db['marker'][this.id];
                  map.map.setView(this.getLatLng(), map.map.getZoom());

                  if(this.options.actionType == 'linkToPvr'){
                    if(this.options.linkedPvr||this.options.linkedPvr===0){
                      linkedPvr = loadData('pvr', this.options.linkedPvr);
                      markerName = ""+linkedPvr.options.name;
                      showPvrData(linkedPvr);
                    }
                    else {
                      pvrPlayer.clearScreen();
                    }              
                  }
                  else if(this.options.actionType == 'linkToVtour'){
                    if(this.options.linkedVtour||this.options.linkedVtour===0){
                      linkedVtour = loadData('vtour', this.options.linkedVtour);
                      markerName = ""+linkedVtour.options.name;
                      if(linkedVtour.options.pvrList.length){
                        linkedPvr = loadData('pvr', linkedVtour.options.pvrList[0].id);
                        showPvrData(linkedPvr);
                      }
                      else{
                        pvrPlayer.setForVtour(linkedVtour.id);
                      }
                    }
                    else{
                      pvrPlayer.clearScreen();
                    }
                  }
                  else if(this.options.actionType == 'showInform'){
                    markerName = this.options.informTitle;
                  }
                  else if(this.options.actionType == 'linkToProject'){
                    loadProject(this.options.linkedProject)
                  }                  
                  else{
                    pvrPlayer.clearScreen();
                  }

                  if(!this.label && markerName){
                    this.bindLabel(markerName, {noHide: true, clickable: true}).showLabel();
                  }
                  else {
                    this.unbindLabel();
                  }
                  
                });
              }
            }
          }
        });
    }

    $(document).ready(function(){
      loadForView();
      setForMenuBar(); 
      setForSizeHandler();
      $('#linkPopupMenuBar .closeBox').click(function(){
        $('#linkPopupContainer').addClass('hidden');
      });
    });

    function showPvrData(newData){
      pvrPlayer.showScene(newData.id);
    }

    function setForMenuBar(){
      //보기 모드의 전환 
      $('#changeViewButton').click(function (){
        //만약 현재 가로 정렬 보기라면 세로 정렬로 변환함
        if(map) map.map._onResize();
        if(viewMode == "h"){
          viewMode = "v";

          $('#totalContainer>div').removeClass('hcomplex');
          $('#totalContainer>div').addClass('vrcomplex');
          $('#leftContainer').css('width', '100%');
          $('#leftContainer').css('height', '50%');
          $('#sizeHandler').removeClass("hSizeHandler");
          $('#sizeHandler').addClass("vSizeHandler");
          $('#modeNameArea').html("세로 보기");hratio = $('#leftContainer').outerWidth()/$('#totalContainer').outerWidth();

          vratio = $('#leftContainer').outerHeight()/$('#totalContainer').outerHeight();
        }
        else if(viewMode == "v"){
          viewMode = "h";

          $('#totalContainer>div').removeClass('vrcomplex');
          $('#totalContainer>div').addClass('hcomplex');         
          $('#leftContainer').css('width', '50%');
          $('#leftContainer').css('height', '100%');
          $('#sizeHandler').removeClass("vSizeHandler");
          $('#sizeHandler').addClass("hSizeHandler");
          $('#modeNameArea').html("가로 보기");

          hratio = $('#leftContainer').outerWidth()/$('#totalContainer').outerWidth();
        }
      });
      $('#changeDataButton').click(function (){
        $(this).addClass('hidden');
        //만약 현재 가로 정렬 보기라면 세로 정렬로 변환함
        setContentsOfRightContainer('pvr');
        loadForView();        
      });
      $('#logoutButton').click(function (){
        if(confirm("로그아웃 하시겠습니까?")){
          $.post("member.php", {req: 'logout'},
            function(result){
              location.replace('login.php');
            }
          );
        }
      });
      $('.barShadow').mousedown(function(mouse){
        $(this).css('display', 'none');
        behindEle = document.elementFromPoint(mouse.clientX, mouse.clientY);
        $(behindEle).mousedown();  
        $(this).css('display', 'block');      
      })
    }

    var vratio, hratio;
    function setForSizeHandler(){
      var isClicked = false, changeSize = false, x,y;          
      
      hratio = $('#leftContainer').outerWidth()/$('#totalContainer').outerWidth();
      vratio = $('#leftContainer').outerHeight()/$('#totalContainer').outerHeight();

      $('#sizeHandler').mousedown(function(ev){
        if(ev.originalEvent) ev.originalEvent.preventDefault();
        else{
          ev.preventDefault();
          ev.stopPropagation()
        } 
        isClicked = true;
      });
      $('body').mouseup(function(ev){
        isClicked = false;        
        if(changeSize){
          changeSize = false;
          if(viewMode == "h"){
            hratio = $('#leftContainer').outerWidth()/$('#totalContainer').outerWidth();
          }
          else if(viewMode == "v"){
            vratio = $('#leftContainer').outerHeight()/$('#totalContainer').outerHeight();
          }
        }      
      });

      $('body').on('mousemove', function(ev){
        var baseWidth;
        if(isClicked){
          changeSize = true;
          if(map) {
            map.map._onResize();
          }
          if(videoPlayer) {
             videoPlayer.container.call('updatescreen()');
          } 

          if(viewMode == "h"){
            baseWidth = $('#totalContainer').outerWidth();
            x = ev.pageX;
            x = Math.max(0+5, x);
            x = Math.min(baseWidth-5, x);          
            $('#leftContainer').css('width', x-5);
          }
          else if(viewMode == "v"){
            baseHeight = $('#totalContainer').outerHeight();
            y = ev.pageY-45;
            y = Math.max(0+5, y);
            y = Math.min(baseHeight-5, y);          
            $('#leftContainer').css('height', baseHeight-y-5);
          }          
        }  
      });

      $(window).resize(function(){
        if(viewMode == "h"){          
          $('#leftContainer').css('width', $('#totalContainer').outerWidth()*hratio);
        }
        else if(viewMode == "v"){
          $('#leftContainer').css('height', $('#totalContainer').outerHeight()*vratio);
        }
      });  
    }
    var db = {
      user: {},
      map: {},
      vtour: {},
      pvr: {},
      layer: {},
      markerIcon: {},
      hotspotIcon: {},
      marker: {},
      hotspot: {},
      polyline: {},
      video: {}
    };

    function loadData(type, id){
      if(!db[type][id]){
        $.ajax({
          async   :false,
          data    :{
            req     :"getNodeData",
            data    :{
              type    :type,
              id      :id
            } 
          },
          dataType:'json',
          type    :'get',
          url     :'getData.php',
          success : function(newData){
            if(type == 'map'){
            }
            if(type == 'layer'){
              if(newData.options.tileImageType == 'presetMap')
                newData.options.maxNativeZoom = 22;
              else
                newData.options.maxNativeZoom = '0';

              map.addTileLayer(newData.id, noCacheUrl(newData.tileUrl), newData.options);
              loadData('map', newData.options.mapId);
            }
            if(type == 'vtour'){
              map.addView(newData.id, newData.latlng, newData.zoom, newData.options);
              pvrPlayer.addVtour(newData.id, newData.xmlPath, newData.options);
              loadData('layer', newData.options.layerId);
            }
            if(type == 'pvr'){
              loadData('vtour', newData.options.vtourId);
              pvrPlayer.addScene(newData.id, newData.options, false);
            }
            db[type][id] = newData;
          }
        });
      }
      return db[type][id];
    }


    function loadProject(project){
      var key;

      $('#pathArea').html('');
      $('#anchor').addClass('hidden');
      $('.propertyElement').addClass('hidden');
      $('#changeDataButton').removeClass('hidden');

      curMainData = null;
      curMainIcon = null;
      map._curLayer = null;

      for(key in db){
        if(key != "user"){
          db[key] = {};  
        }        
      }

      if(map) map.map.remove();
      if(pvrPlayer){
        removepano('myKrpano');
        pvrPlayer = null;
      } 
      if(videoPlayer){
        removepano('videoKrpano');
        videoPlayer = null;
      } 
      $('.iconBox:not(.first)').remove();


      //-----------------------------
      //새로운 프로젝트 정보를 불러옴
      projectId = project;
      showProject = true;
      map = new Map(0, "mapContainer", {
        mode  : "edit",
        useView : true,
      });
      
      map.map.on('baselayerchange', function (ev){
        var i, layerList, layer;

        setContentsOfRightContainer('pvr');

        i = ev.layer.id;
        layer = loadData('layer', i); 
        if(layer.options.mainPvr){
          loadData('pvr', layer.options.mainPvr)
          pvrPlayer.showScene(layer.options.mainPvr);
        }
        else {
          pvrPlayer.clearScreen();
        }
      });

      embedpano({
        target: "videoContainer", 
        id: "videoKrpano", 
        bgcolor: "#FFFFFF",  
        swf: "source/videoPlayer/krpano.swf",
        xml: noCacheUrl("source/videoPlayer/krpano.xml"),
        wmode: "transparent",
        html5: 'never',
        onready: setVideoPlayer
      });
      embedpano({
        target: "pvrContainer", 
        id: "myKrpano", 
        bgcolor: "#FFFFFF", 
        html5: "only", 
        swf: "krpano.swf",
        xml: noCacheUrl("template/krpano.xml"),
        onready: setPvrPlayer
      });

      setContentsOfRightContainer('pvr');

      loadData('map', projectId);
      for(i=0; i<db.map[projectId].options.layerList.length; i++){
        loadData('layer', db.map[projectId].options.layerList[i].id);
      }
      map.drawLayerController(db.map[projectId].options.layerList);
      $('#viewNameArea').html(db.map[projectId].options.name);

      //marker icon 생성
      $.ajax({
        async: false,
        type: 'get',
        url: 'getData.php', 
        data:{
          req: "getMarkerIconList", 
          data: {
            projectId: projectId
          }
        },
        dataType: 'json',
        success: function (data){
          var i, newNode,
              midX, midY;

          for(i=0; i<data.length; i++){
            newNode = data[i];

            midX = data[i].options.size.x/2;
            midY = data[i].options.size.y/2;

            newNode.options.iconAnchor = {x:midX, y:midY};
            newNode.options.type = "markerIcon";

            db[newNode.options.type][newNode.id] = newNode;          
            map.addIcon(newNode.id, newNode.options); 
          }
        }
      });

      $.get('getData.php', {
        req: "getMarkerList", 
        data: {
          projectId: projectId
        }
      }, function (data){
        var i, newNode, newMarker,
            midX, midY;

        for(i=0; i<data.length; i++){
          newNode = data[i];

          loadData('layer', newNode.options.layerId);
          db[newNode.options.type][newNode.id] = newNode; 

          newNode.options.draggable = false;         
          newMarker = map.addMarker(newNode.id, newNode.latlng, newNode.options);          
          newMarker.on('click', function (){
            var linkedPvr, linkedVtour, markerName = null;
          
            setContentsOfRightContainer('pvr');

            if(curMainIcon && curMainIcon.id != this.id){
              map.markerList[curMainIcon.id].unbindLabel();
            } 

            curMainIcon = db['marker'][this.id];

            if(this.options.actionType == 'linkToPvr'){
              if(this.options.linkedPvr || this.options.linkedPvr ===0){
                linkedPvr = loadData('pvr', this.options.linkedPvr);
                showPvrData(linkedPvr);

                if(this.options.informTitle){
                  markerName = this.options.informTitle;
                }
                else {
                  markerName = ""+linkedPvr.options.name;
                }
              }
              else {
                pvrPlayer.clearScreen();
              } 

              if(this.options.informTitle){
                markerName = this.options.informTitle;
              }     
            }
            else if(this.options.actionType == 'linkToVtour' && (this.options.linkedVtour || this.options.linkedVtour ===0)){
              linkedVtour = loadData('vtour', this.options.linkedVtour);
              markerName = ""+linkedVtour.options.name;

              if(linkedVtour.options.pvrList.length){
                linkedPvr = loadData('pvr', linkedVtour.options.pvrList[0].id);
                showPvrData(linkedPvr);       
              }
              else {
                pvrPlayer.setForVtour(linkedVtour.id);
              }       
            }
            else if(this.options.actionType == 'showInform'){
              markerName = this.options.informTitle;
              pvrPlayer.clearScreen();      
            }
            else{
              pvrPlayer.refresh();
            }

            if(this.options.actionType == 'linkToPvr' || this.options.actionType == 'linkToVtour' || this.options.actionType == 'showInform'){
              if(!this.label && markerName){
                this.bindLabel(markerName, {noHide: true, clickable: true}).showLabel();
                this.label.on('click', (function (){
                  var labelMode = "title", labelTitle = markerName;
                  return function(){
                    var htmlForLabel, htmlForText;

                    if(labelMode == "title"){
                      labelMode = "inform";

                      if(this._source.options.informType == "text"){
                        htmlForLabel = '<div class="labelForInformation">';
                        if(this._source){
                          htmlForLabel += '<div class="titleContainer">'+labelTitle+'</div>';
                
                          if(this._source.options.informImgUrl){
                            htmlForLabel += '<div class="imgContainer"><img src="'+this._source.options.informImgUrl+'"></div>';
                          }
                          if(this._source.options.informText){
                            htmlForText = this._source.options.informText.replace(/\n/g, '<br>');
                            htmlForLabel += '<div class="textContainer">'+htmlForText+'</div>';
                          }
                        }
                        htmlForLabel += '</div>';
                        this.setContent(htmlForLabel);
                      }
                      else if(this._source.options.informType == "url"){
                        labelMode = "title";
                        $('#linkPopupContainer').removeClass('hidden');
                        $('#linkPopupBody iframe').attr('src', this._source.options.linkedUrl);
                      }         
                    }
                    else if(labelMode == "inform"){
                      labelMode="title";

                      htmlForLabel = labelTitle;
                      this.setContent(htmlForLabel);
                    }
                  }
                })());
              }
              else {
                this.unbindLabel();
              } 
            }
            map.map.setView(this.getLatLng(), map.map.getZoom());
          });
        }
      }, 'json');
    }

    function setPvrPlayer(){
      pvrPlayer = new PvrPlayer(myKrpano, "pvrPlayer");

      if(showProject){
        $.ajax({
          async: false,
          type: 'get',
          url: 'getData.php', 
          data:{
            req: "getHotspotIconList", 
            data: {
              projectId: projectId
            }
          },
          dataType: 'json',
          success: function (data){
            var i, newNode,
                midX, midY;

            for(i=0; i<data.length; i++){
              newNode = data[i];

              midX = data[i].options.size.x/2;
              midY = data[i].options.size.y/2;

              newNode.options.iconAnchor = {x:midX, y:midY};
              newNode.options.type = "hotspotIcon";

              db[newNode.options.type][newNode.id] = newNode;          
              pvrPlayer.addIcon(newNode.id, newNode.options); 
            }
          }
        });
        $.get('getData.php', {
          req: "getHotspotList", 
          data: {
            projectId: projectId
          }
        }, function (data){
          var i, newNode, newHotspot;

          for(i=0; i<data.length; i++){
            newNode = data[i];

            loadData('pvr', newNode.options.sceneId);
            db[newNode.options.type][newNode.id] = newNode;
            newHotspot = pvrPlayer.addHotspot(newNode.id, newNode.ath, newNode.atv, newNode.options, false);
            setHotspot(newHotspot);          
          }
        }, 'json');
      }
    }
    function setHotspot(hotspot){
      hotspot.on('click', function(){
        if(this.options.actionType == "linkToPvr"){
          loadData('pvr', this.options.linkedPvr);          

          pvrPlayer.krpano.call("tween(hotspot[h"+this.id+"].scale,0.25,0.5); tween(hotspot[h"+this.id+"].oy,-40,0.5); tween(hotspot[h"+this.id+"].alpha,0,0.5);");
          pvrPlayer.krpano.call("looktohotspot(h"+this.id+")");
          
          pvrPlayer.showScene(this.options.linkedPvr);
        }
        else if(this.options.actionType == "showInform"){
          var x, y;
          pvrPlayer.krpano.call("spheretoscreen(hotspot[h"+hotspot.id+"].ath, hotspot[h"+hotspot.id+"].atv, x, y)");
          x = pvrPlayer.krpano.get("x");
          y = pvrPlayer.krpano.get("y");
        }                             
      })
    }
    function noCacheUrl(url){
      return url+'?'+(new Date()).getTime();
    }
    function showLayerData(newData){
      var mapData, newId;

      map.changeLayer(newData.id);
      map.map.setView(newData.options.mainView.latlng, newData.options.mainView.zoom, {animate:false});
      if(curMainIcon){
        newId = curMainIcon.options.type=="markerIcon"?"mic":"hic";
        newId += curMainIcon.id;
        $('#'+newId).click();
      }
    }




    /**
     * setContentsOfRightContainer
     *  change the contents that are  shown on the right container
     *
     * @param type
     *  type of contents
     */

    function setContentsOfRightContainer(type) {
      switch(type) {
        case "pvr":
        $('.pvrContents').removeClass('transparent');
        $('.videoContents').addClass('transparent');
        if(videoPlayer) {
          videoPlayer.clearVideo();
        }        
        break;

        case "video":
        $('.videoContents').removeClass('transparent');
        $('.pvrContents').addClass('transparent');
        if(curMainIcon) {
          map.markerList[curMainIcon.id].unbindLabel();
          curMainIcon = null;
        }        
        break;
      }
    }

    /**
     * setVideoPlayer
     *  used as the callback of embedpano
     */

    function setVideoPlayer() {
      var newLayerId;

      videoPlayer = new VideoPlayer(videoKrpano, {
        mode: "krpano"
      });

      //load every video of project from server
      loadDataListFromServer('video');
      //videoPlayer must be defined for polyline
      //load every polyline of project from server
      loadDataListFromServer('polyline');

      //after the polylines are loaded, tile layer is shown on the map
      newLayerId = db.map[projectId].options.layerList[0].id;
      layer = loadData('layer', newLayerId);
      showLayerData(db.layer[newLayerId]);
      loadData('pvr', layer.options.mainPvr);
      pvrPlayer.showScene(layer.options.mainPvr);
    }

    /**
     * loadDataListFromServer
     *  load videolist, polyline list
     *
     * @param type
     *  type of data to load
     */
    function loadDataListFromServer(type){
      var str, allowedType;

      allowedType = ['video', 'polyline'];
      if($.inArray(type, allowedType) === -1) {
        console.error('loadDataListFromServer: input wrong data type')
        return false;
      }

      //change first character to upper case
      str = type.charAt(0).toUpperCase() + type.slice(1);
      $.ajax({
        async: false,
        url: 'getData.php',
        type: 'get',
        data: {
          req: 'get' + str + 's',
          data: {
            projectId: projectId
          }
        },
        dataType: 'json',
        success: function (dataList) {
          var i, j, data, newPolyline;

          for(i=0; i<dataList.length; i++) {
            data = dataList[i];
            
            //insert data to js global db
            db[type][data.id] = data;

            //make a object from returned data from server
            switch(type) {
              //video don't have extra object that controls it.\
              case 'video':
              break;

              case 'polyline':
              //insert video object for polyline
              data.options.video = db.video[data.options.videoId];
              //insert contents object for polyline
              data.options.contents = {
                map: map.map,
                videoPlayer: videoPlayer
              };
              //add polyline to map object
              newPolyline = map.addPolyline(data.id, data.layerId, data.options);
              //add timeline of the polyline add to map
              for(j=0; j<data.options.timelineList.length; j++) {
                timeline = data.options.timelineList[j];
                newPolyline.addTimeline(timeline.perAtStart, timeline.perAtEnd, timeline.latlng);
              }
              //when the line cliked, right container show 360 video 
              newPolyline.onToLine('click', function(){
                setContentsOfRightContainer('video');
              });

              //when the line is remove from map, the related video have to be stopped
              newPolyline.timelines[0].lines[0].on('remove', function () {
                var curActivePolyline;
                curActivePolyline = videoPlayer.getPolyline();
                if(curActivePolyline && curActivePolyline.id == this.parentPolyline.id){
                  videoPlayer.clearVideo();
                }
              });
              
              newPolyline.hide();
              break;
            }
          }

          //because polyline is hidden at first, show polyline by reset tile layer 
          map.refresh();
        }
      });
    }

    </script>
    </div>
  </body>
  <head>
    <meta Http-Equiv="Cache-Control" Content="no-cache">
    <meta Http-Equiv="Pragma" Content="no-cache">
    <meta Http-Equiv="Expires" Content="0">
    <meta Http-Equiv="Pragma-directive: no-cache">
    <meta Http-Equiv="Cache-directive: no-cache">
  </head>
</html>